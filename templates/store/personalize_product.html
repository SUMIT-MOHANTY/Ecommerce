{% extends 'base.html' %}

{% block title %}Personalise {{ product.name }} - Customise Clothing{% endblock %}

{% block content %}
<style>
  .personalize-container {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    padding: 2rem 0;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .personalize-card {
    background: white;
    border-radius: 1.5rem;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    max-width: 800px;
    margin: 0 auto;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .personalize-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .personalize-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .personalize-subtitle {
    opacity: 0.9;
    font-size: 1.1rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .personalize-content {
    padding: 2rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .product-preview {
    text-align: center;
    margin-bottom: 2rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .product-image {
    width: 200px;
    height: 200px;
    object-fit: cover;
    border-radius: 1rem;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .upload-section {
    background: #f8fafc;
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .upload-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 1rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .upload-instructions {
    color: #64748b;
    margin-bottom: 1.5rem;
    line-height: 1.6;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .file-upload {
    border: 2px dashed #cbd5e0;
    border-radius: 1rem;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .file-upload:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
  }
  
  .file-upload.dragover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
  }
  
  .upload-icon {
    font-size: 3rem;
    color: #cbd5e0;
    margin-bottom: 1rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .upload-text {
    color: #64748b;
    margin-bottom: 1rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .upload-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
  }
  
  .submit-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 1.1rem;
    width: 100%;
    transition: all 0.3s ease;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
  }
  
  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  
  .preview-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 1rem;
    margin-top: 1rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .form-group {
    margin-bottom: 1.5rem;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #2d3748;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .form-group input[type="file"] {
    display: none;
  }
  
  /* Size option styling */
  .size-option {
    position: relative;
    transition: all 0.3s ease !important;
  }

  .size-option:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
  }

  .size-option.active {
    background-color: #667eea !important;
    color: white !important;
    border-color: #667eea !important;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important;
  }
</style>

<div class="personalize-container">
  <div class="container">
    <div class="personalize-card">
      <div class="personalize-header">
        <h1 class="personalize-title">Personalize Your {{ product.name }}</h1>
        <p class="personalize-subtitle">Upload your custom design and we'll create it for you</p>
      </div>
      
      <div class="personalize-content">
        <div class="product-preview">
          {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
          {% else %}
            <div class="product-image" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-tshirt" style="font-size: 3rem; color: #cbd5e0;"></i>
            </div>
          {% endif %}
        </div>
        
        {% if user.is_authenticated %}
        <form method="post" enctype="multipart/form-data" id="personalizationForm">
          {% csrf_token %}
          
          {% if available_sizes %}
          <div class="upload-section">
            <h3 class="upload-title">Select Size</h3>
            <p class="upload-instructions">
              Please select the size for your personalized {{ product.name }}.
            </p>
            
            <div class="d-flex flex-wrap gap-2 mb-3">
              {% for size in available_sizes %}
              <button type="button" class="btn btn-outline-secondary size-option"
                      data-size="{{ size.code }}"
                      style="min-width: 40px; padding: 8px 12px; border-radius: 6px; transition: all 0.2s ease;"
                      title="Size {{ size.code }}">
                {{ size.code }}
              </button>
              {% endfor %}
            </div>
            
            <small class="text-muted d-block mb-3">
              Sizes available for this product ({{ available_sizes|length }} option{{ available_sizes|length|pluralize }}).
              <span id="selected-size-text" class="text-primary" style="display: none;">
                Selected: <strong id="selected-size-value"></strong>
              </span>
            </small>
            
            <!-- Hidden input to store selected size -->
            <input type="hidden" name="selected_size" id="selected_size_input" value="">
          </div>
          {% endif %}
          
          <div class="upload-section">
            <h3 class="upload-title">Upload Your Design</h3>
            <p class="upload-instructions">
              Please upload a high-quality image of your design. We accept JPG, PNG, and GIF files up to 10MB.
              Make sure your design is clear and suitable for printing on {{ product.name }}.
            </p>
            
            <div class="file-upload" id="fileUpload">
              <i class="fas fa-cloud-upload-alt upload-icon"></i>
              <p class="upload-text">Click to upload or drag and drop your design here</p>
              <button type="button" class="upload-btn" onclick="document.getElementById('id_uploaded_image').click()">
                Choose File
              </button>
              {{ form.uploaded_image }}
            </div>
            
            <div id="imagePreview" style="display: none;">
              <img id="previewImg" class="preview-image" alt="Preview">
            </div>
          </div>
          
          <button type="submit" class="submit-btn" id="submitBtn">
            <i class="fas fa-paper-plane" style="margin-right: 0.5rem;"></i>
            Submit Personalization Request
          </button>
        </form>
        {% else %}
        <div class="alert alert-warning text-center">
          <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
          You must be logged in to submit a personalization request.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const fileInput = document.getElementById('id_uploaded_image');
  const fileUpload = document.getElementById('fileUpload');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  const submitBtn = document.getElementById('submitBtn');
  const selectedSizeInput = document.getElementById('selected_size_input');
  let selectedSize = null;
  
  // Handle size selection
  document.querySelectorAll('.size-option').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all size buttons
      document.querySelectorAll('.size-option').forEach(b => {
        b.classList.remove('active');
        b.style.backgroundColor = '';
        b.style.color = '';
        b.style.borderColor = '';
      });
      
      // Add active class to clicked button
      this.classList.add('active');
      this.style.backgroundColor = '#667eea';
      this.style.color = 'white';
      this.style.borderColor = '#667eea';
      
      selectedSize = this.getAttribute('data-size');
      selectedSizeInput.value = selectedSize;

      // Update selected size display
      const selectedSizeText = document.getElementById('selected-size-text');
      const selectedSizeValue = document.getElementById('selected-size-value');
      if (selectedSizeText && selectedSizeValue) {
        selectedSizeValue.textContent = selectedSize;
        selectedSizeText.style.display = 'inline';
      }
    });
  });
  
  // Handle file selection
  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        imagePreview.style.display = 'block';
        submitBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }
  });
  
  // Drag and drop functionality
  fileUpload.addEventListener('dragover', function(e) {
    e.preventDefault();
    fileUpload.classList.add('dragover');
  });
  
  fileUpload.addEventListener('dragleave', function(e) {
    e.preventDefault();
    fileUpload.classList.remove('dragover');
  });
  
  fileUpload.addEventListener('drop', function(e) {
    e.preventDefault();
    fileUpload.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      fileInput.dispatchEvent(new Event('change'));
    }
  });
  
  // Form submission validation
  document.getElementById('personalizationForm').addEventListener('submit', function(e) {
    // Check if sizes are available and enforce selection
    const hasSizes = document.querySelectorAll('.size-option').length > 0;
    if (hasSizes && !selectedSize) {
      e.preventDefault();
      alert('Please select a size before submitting your personalization request.');
      return false;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Submitting...';
  });
});
</script>
{% endblock %} 